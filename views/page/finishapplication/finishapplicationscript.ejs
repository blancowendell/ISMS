<script>
    let studentId = "<%= studentid %>";
    let base64StringGradeCopy = "";
    let base64StringRegForm = "";
    let base64StringCertRes = "";
    let base64StringItr = "";
    let base64StringNfi = "";
    let base64profileImage = "";

    $(document).ready(function () {
        loadStudentData();
        //LoadInstitutions();
        //LoadCoursesOnly();
        LoadScholarshipId();

        $(document).on("keydown", function (event) {
            // Check if the Enter key is pressed
            if (event.key === "Enter") {
                // Trigger the button click
                $("#submit").click();
            }
        });

        function validateGradeInput(input) {
            // Match numbers with up to 2 digits and 2 decimal places
            const regex = /^\d{0,2}(\.\d{0,2})?$/;
            const value = input.value;

            if (!regex.test(value)) {
                // If input doesn't match, reset it
                input.value = value.slice(0, -1);
            }
        }

        // Apply the validation function on input event
        document.getElementById("firstSemGrade").addEventListener("input", function () {
            validateGradeInput(this);
        });

        document.getElementById("secondSemGrade").addEventListener("input", function () {
            validateGradeInput(this);
        });

        console.log(studentId, 'id');


        // $("#school_name").change(function () {
        //     var institutionId = $(this).val();
        //     if (institutionId) {
        //         LoadCourses(institutionId);
        //     }
        // });


        // function LoadInstitutions() {
        //     $.ajax({
        //         type: "GET",
        //         url: "/institutions/loadinstitutions",
        //         success: function (result) {
        //             var data = result.data;

        //             $.each(data, function (key, item) {
        //                 var options = new Option(item.institutionsid, item.institutionsid);
        //                 $(options).html(item.name);
        //                 $("#school_name").append(options);
        //             });
        //         },
        //         error: function (result) {
        //             alert("error: " + result.data);
        //         },
        //     });
        // }

        // function LoadCourses(institutionId) {
        //     $.ajax({
        //         type: "POST",
        //         url: "/institutions/loadcourses",
        //         data: { institutionsid: institutionId },
        //         success: function (result) {
        //             var data = result.data;
        //             $("#course_strand").empty();

        //             $.each(data, function (key, item) {
        //                 var options = new Option(item.course_id, item.course_id);
        //                 $(options).html(item.name_code);
        //                 $("#course_strand").append(options);
        //             });
        //         },
        //         error: function (result) {
        //             alert("error: " + result.data);
        //         },
        //     });
        // }

        // function LoadCoursesOnly() {
        //     $.ajax({
        //         type: "GET",
        //         url: "/courses/loadcourses",
        //         success: function (result) {
        //             var data = result.data;
        //             $.each(data, function (key, item) {
        //                 var options = new Option(item.course_id, item.course_id);
        //                 $(options).html(item.name_code);
        //                 $("#course_strand").append(options);
        //             });
        //         },
        //         error: function (result) {
        //             alert("error: " + result.data);
        //         },
        //     });
        // }

        function LoadScholarshipId() {
            $.ajax({
                type: "GET",
                url: "/scholarship/loadscholarlandingpage",
                success: function (result) {
                    var data = result.data;
                    $.each(data, function (key, item) {
                        var options = new Option(item.scholarship_id, item.scholarship_id);
                        $(options).html(item.name);
                        $("#scholarshipidchoice").append(options);
                    });
                },
                error: function (result) {
                    alert("error: " + result.data);
                },
            });
        }

        function capitalizeFirstLetter(input) {
            return input.toLowerCase().replace(/\b\w/g, function (char) {
                return char.toUpperCase();
            });
        }

        $(document).on("click", "#submit", function () {
            let first_name = $("#first_name").val();
            let middle_name = $("#middle_name").val();
            let last_name = $("#last_name").val();
            let dob = $("#dob").val();
            let birthplace = $("#birthplace").val();
            let phone = $("#phone").val();
            let gender = $("#gender").val();
            let age = $("#age").val();
            let scholar_status = $("#scholar_status").val();
            // let student_id = $("#student_id").val();
            let school_name = $("#school_name").val();
            let course_strand = $("#course_strand").val();
            let year_level = $("#year_level").val();
            let academic_status = $("#academic_status").val();
            let register_date = $("#register_date").val();
            let city = $("#city").val();
            let barangay = $("#barangay").val();
            let village = $("#village").val();
            let street_address = $("#street_address").val();
            let houseno = $("#houseno").val();
            let fathersname = $("#fathersname").val();
            let fathersmonthly = $("#fathersmonthly").val();
            let fathersoccupation = $("#fathersoccupation").val();
            let mothersname = $("#mothersname").val();
            let mothersoccupation = $("#mothersoccupation").val();
            let mothersmonthly = $("#mothersmonthly").val();
            let scholarshipid = $("#scholarshipidchoice").val();
            let firstSemGrade = $("#firstSemGrade").val();
            let secondSemGrade = $("#secondSemGrade").val();
            let imageFile = base64profileImage;
            let imageFileGradeCopy = base64StringGradeCopy;
            let imageFileRegForm = base64StringRegForm;
            let imageFileCertRes = base64StringCertRes;
            let imageFileItr = base64StringItr;
            let imageFileNfi = base64StringNfi;
            let studentid = studentId;
            var message = "";


            school_name = capitalizeFirstLetter(school_name);
            //course_strand = capitalizeFirstLetter(course_strand);

            console.log(imageFileGradeCopy, 'image');
            console.log(studentId, 'id');

            if (first_name === "") {
                message += "First name is required. ";
            }

            if (middle_name === "") {
                message += "Middle name is required. ";
            }

            if (last_name === "") {
                message += "Last name is required. ";
            }

            if (dob === "") {
                message += "Date of birth is required. ";
            }

            if (birthplace === "") {
                message += "Birthplace is required. ";
            }

            if (phone === "") {
                message += "Phone is required. ";
            }

            if (gender === "") {
                message += "Gender is required. ";
            }

            if (age === "") {
                message += "Age is required. ";
            }

            if (scholar_status === "") {
                message += "Scholar status is required. ";
            }

            if (school_name === "") {
                message += "School name is required. ";
            }

            if (course_strand === "") {
                message += "Course strand is required. ";
            }

            if (year_level === "") {
                message += "Year level is required. ";
            }

            if (academic_status === "") {
                message += "Academic status is required. ";
            }

            if (register_date === "") {
                message += "Register date is required. ";
            }

            if (city === "") {
                message += "City is required. ";
            }

            if (barangay === "") {
                message += "Barangay is required. ";
            }

            if (village === "") {
                message += "Village is required. ";
            }

            if (street_address === "") {
                message += "Street address is required. ";
            }

            if (houseno === "") {
                message += "House number is required. ";
            }

            if (fathersname === "") {
                message += "Father's name is required. ";
            }

            if (fathersmonthly === "") {
                message += "Father's monthly salary is required. ";
            }

            if (fathersoccupation === "") {
                message += "Father's occupation is required. ";
            }

            if (mothersname === "") {
                message += "Mother's name is required. ";
            }

            if (mothersoccupation === "") {
                message += "Mother's occupation is required. ";
            }

            if (mothersmonthly === "") {
                message += "Mother's monthly salary is required. ";
            }

            if (scholarshipid === "") {
                message += "Scholarship id is required. ";
            }


            if (message !== "") {
                swal("Validation Error", message, "error");
            } else {
                swal({
                    title: "Processing...",
                    text: "Please wait while your data is being saved.",
                    icon: "info",
                    buttons: false,
                    closeOnClickOutside: false,
                    closeOnEsc: false,
                });

                $.ajax({
                    type: "POST",
                    url: "/finishapplication/save",
                    data: {
                        studentid: studentid,
                        first_name: first_name,
                        middle_name: middle_name,
                        last_name: last_name,
                        dob: dob,
                        birthplace: birthplace,
                        phone: phone,
                        gender: gender,
                        age: age,
                        scholar_status: scholar_status,
                        school_name: school_name,
                        course_strand: course_strand,
                        year_level: year_level,
                        academic_status: academic_status,
                        register_date: register_date,
                        city: city,
                        barangay: barangay,
                        village: village,
                        street_address: street_address,
                        houseno: houseno,
                        fathersname: fathersname,
                        fathersmonthly: fathersmonthly,
                        fathersoccupation: fathersoccupation,
                        mothersname: mothersname,
                        mothersoccupation: mothersoccupation,
                        mothersmonthly: mothersmonthly,
                        imageFile: imageFile,
                        imageFileGradeCopy: imageFileGradeCopy,
                        imageFileRegForm: imageFileRegForm,
                        imageFileCertRes: imageFileCertRes,
                        imageFileItr: imageFileItr,
                        imageFileNfi: imageFileNfi,
                        scholarshipid: scholarshipid,
                        firstSemGrade: firstSemGrade,
                        secondSemGrade: secondSemGrade,
                    },
                    success: function (result) {
                        // Close loading state
                        swal.close();

                        if (result.msg == "success") {
                            swal({
                                title: "Submitted Successfully",
                                text: "Your application has been submitted wait for the admin to approve it.",
                                icon: "success",
                                button: "OK!",
                            }).then((results) => {
                                window.location.reload();
                            });
                        } else {
                            swal({
                                title: "Exist",
                                text: "Data already exists!",
                                icon: "warning",
                                button: "OK!",
                            });
                        }
                    },
                    error: function (err) {
                        // Close loading state
                        swal.close();

                        swal("Error", "Something went wrong while saving your data.", "error");
                    },
                });
            }
        });


        function loadStudentData() {
            $.ajax({
                type: "GET",
                url: "/finishapplication/checkStudentExistence", // New endpoint
                success: function (result) {
                    if (result.msg === "existsInBoth") {
                        $.ajax({
                            type: "POST",
                            url: "/finishapplication/loadexistingrecord", // Fetch from master_students_request
                            data: { studentid: studentId },
                            success: function (requestResult) {
                                if (requestResult.msg === "success") {
                                    const existingData = requestResult.data;
                                    console.log(existingData, 'data from master_students_request');

                                    $.each(existingData, (key, item) => {
                                        $("#first_name").val(item.first_name);
                                        $("#middle_name").val(item.middle_name);
                                        $("#last_name").val(item.last_name);
                                        $("#dob").val(item.date_of_birth);
                                        $("#birthplace").val(item.birthplace);
                                        $("#phone").val(item.phone);
                                        $("#gender").val(item.gender);
                                        $("#age").val(item.age);
                                        $("#scholar_status").val(item.status);
                                        $("#student_id").val(item.studentid);
                                        $("#school_name").val(item.institutionid);
                                        $("#course_strand").val(item.courseid);
                                        $("#year_level").val(item.yearlevel);
                                        $("#academic_status").val(item.academic_status);
                                        $("#register_date").val(item.registerdate);
                                        $("#city").val(item.city);
                                        $("#barangay").val(item.baranggay);
                                        $("#village").val(item.village);
                                        $("#street_address").val(item.street);
                                        $("#houseno").val(item.house_no);
                                        $("#fathersname").val(item.fathers_name);
                                        $("#fathersmonthly").val(item.fathers_salary);
                                        $("#fathersoccupation").val(item.fathers_occupation);
                                        $("#mothersname").val(item.mothers_name);
                                        $("#mothersoccupation").val(item.mothers_occupation);
                                        $("#mothersmonthly").val(item.mothers_salary);
                                        $("#firstSemGrade").val(item.first_sem_grade);
                                        $("#secondSemGrade").val(item.second_sem_grade);
                                        $("#profileimagepreview").attr("src", "data:image/jpg;base64," + item.image);
                                        base64profileImage = item.image;
                                        $("#truecopypreview").attr("src", "data:image/jpg;base64," + item.grade_copy);
                                        base64StringGradeCopy = item.grade_copy;
                                        $("#regformpreview").attr("src", "data:image/jpg;base64," + item.registration_form);
                                        base64StringRegForm = item.registration_form;
                                        $("#certrespreview").attr("src", "data:image/jpg;base64," + item.certificate_residency);
                                        base64StringCertRes = item.certificate_residency;
                                        $("#itipreview").attr("src", "data:image/jpg;base64," + item.itr);
                                        base64StringItr = item.itr;
                                        $("#nfipreview").attr("src", "data:image/jpg;base64," + item.nfi);
                                        base64StringNfi = item.nfi;
                                    });
                                } else {
                                    swal("Error fetching student data", requestResult.message, "error");
                                }
                            },
                            error: function (err) {
                                swal("An error occurred while fetching student data from master_students_request", err.message, "error");
                            }
                        });
                    } else if (result.msg === "existsInMasterOnly") {
                        // Call signuppagedata
                        $.ajax({
                            type: "GET",
                            url: "/finishapplication/signuppagedata", // Fetch from master_students
                            success: function (result) {
                                if (result.msg === "success") {
                                    const existingData = result.data;
                                    console.log(existingData, 'data from master_students');

                                    $.each(existingData, (key, item) => {
                                        $("#first_name").val(item.first_name);
                                        $("#middle_name").val(item.middle_name);
                                        $("#last_name").val(item.last_name);
                                        $("#dob").val(item.date_of_birth);
                                        $("#birthplace").val(item.birthplace);
                                        $("#phone").val(item.phone);
                                        $("#gender").val(item.gender);
                                        $("#age").val(item.age);
                                        $("#scholar_status").val(item.status);
                                        $("#school_name").val(item.institutionid);
                                        $("#course_strand").val(item.courseid);
                                        $("#year_level").val(item.yearlevel);
                                        $("#academic_status").val(item.academic_status);
                                        $("#register_date").val(item.registerdate);
                                        $("#scholarshipidchoice").val(item.scholarshipid);
                                    });
                                } else {
                                    swal("Error fetching student data", result.message, "error");
                                }
                            },
                            error: function (err) {
                                swal("An error occurred while checking application status", err.message, "error");
                            }
                        });
                    } else {
                        swal("No student record found", "Please check the student ID.", "error");
                    }
                },
                error: function (err) {
                    swal("An error occurred while checking student existence", err.message, "error");
                }
            });
        }




        // function loadStudentData() {
        //     $.ajax({
        //         type: "GET",
        //         url: "/finishapplication/load",
        //         success: function (result) {
        //             if (result.status === "exists") {
        //                 swal("Already Submitted", "You have already submitted your application.", "info")
        //                     .then(() => {
        //                         window.location.href = "/studentindex";
        //                     });
        //             } else {
        //                 $.ajax({
        //                     type: "POST",
        //                     url: "/finishapplication/loadexistingrecord",
        //                     data: { studentid: studentId },
        //                     success: function (result) {
        //                         if (result.msg === "success") {
        //                             const existingData = result.data;

        //                             console.log(existingData, 'data');

        //                             $.each(existingData, (key, item) => {
        //                                 $("#first_name").val(item.first_name);
        //                                 $("#middle_name").val(item.middle_name);
        //                                 $("#last_name").val(item.last_name);
        //                                 $("#dob").val(item.date_of_birth);
        //                                 $("#birthplace").val(item.birthplace);
        //                                 $("#phone").val(item.phone);
        //                                 $("#gender").val(item.gender);
        //                                 $("#age").val(item.age);
        //                                 $("#scholar_status").val(item.status);
        //                                 $("#student_id").val(item.studentid);
        //                                 $("#school_name").val(item.institutionid);
        //                                 $("#course_strand").val(item.courseid);
        //                                 $("#year_level").val(item.yearlevel);
        //                                 $("#academic_status").val(item.academic_status);
        //                                 $("#register_date").val(item.registerdate);
        //                                 $("#city").val(item.city);
        //                                 $("#barangay").val(item.baranggay);
        //                                 $("#village").val(item.village);
        //                                 $("#street_address").val(item.street);
        //                                 $("#houseno").val(item.house_no);
        //                                 $("#fathersname").val(item.fathers_name);
        //                                 $("#fathersmonthly").val(item.fathers_salary);
        //                                 $("#fathersoccupation").val(item.fathers_occupation);
        //                                 $("#mothersname").val(item.mothers_name);
        //                                 $("#mothersoccupation").val(item.mothers_occupation);
        //                                 $("#mothersmonthly").val(item.mothers_salary);
        //                                 $("#firstSemGrade").val(item.first_sem_grade);
        //                                 $("#secondSemGrade").val(item.second_sem_grade);
        //                                 $("#profileimagepreview").attr("src", "data:image/jpg;base64," + item.image);
        //                                 base64profileImage = item.image;
        //                                 $("#truecopypreview").attr("src", "data:image/jpg;base64," + item.grade_copy);
        //                                 base64StringGradeCopy = item.grade_copy;
        //                                 $("#regformpreview").attr("src", "data:image/jpg;base64," + item.registration_form);
        //                                 base64StringRegForm = item.registration_form;
        //                                 $("#certrespreview").attr("src", "data:image/jpg;base64," + item.certificate_residency);
        //                                 base64StringCertRes = item.certificate_residency;
        //                                 $("#itipreview").attr("src", "data:image/jpg;base64," + item.itr);
        //                                 base64StringItr = item.itr;
        //                                 $("#nfipreview").attr("src", "data:image/jpg;base64," + item.nfi);
        //                                 base64StringNfi = item.nfi;
        //                             });
        //                         } else {
        //                             swal("Error fetching student data", result.message, "error");
        //                         }
        //                     },
        //                     error: function (err) {
        //                         swal("An error occurred while fetching student data", err.message, "error");
        //                     }
        //                 });
        //             }
        //         },
        //         error: function (err) {
        //             swal("An error occurred while checking application status", err.message, "error");
        //         }
        //     });
        // }
        //#region File Upload



        $(document).on("change", "#profileImage", function (e) {
            const input = document.getElementById("profileImage");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("profileimagepreview");
                preview.src = reader.result;
            };
            profileImage();
        });

        function profileImage() {
            const input = document.getElementById("profileImage");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64profileImage = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64profileImage;
            };
            reader.readAsDataURL(file);
        }

        $(document).on("change", "#reqtruecopygrade", function (e) {
            const input = document.getElementById("reqtruecopygrade");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("truecopypreview");
                preview.src = reader.result;
            };
            trueCopyGrade();
        });

        function trueCopyGrade() {
            const input = document.getElementById("reqtruecopygrade");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringGradeCopy = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringGradeCopy;
            };
            reader.readAsDataURL(file);
        }


        $(document).on("change", "#reqregform", function (e) {
            const input = document.getElementById("reqregform");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("regformpreview");
                preview.src = reader.result;
            };
            registrationForm();
        });

        function registrationForm() {
            const input = document.getElementById("reqregform");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringRegForm = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringRegForm;
            };
            reader.readAsDataURL(file);
        }


        $(document).on("change", "#reqcertres", function (e) {
            const input = document.getElementById("reqcertres");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("certrespreview");
                preview.src = reader.result;
            };
            certificateResidency();
        });

        function certificateResidency() {
            const input = document.getElementById("reqcertres");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringCertRes = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringCertRes;
            };
            reader.readAsDataURL(file);
        }


        $(document).on("change", "#reqitr", function (e) {
            const input = document.getElementById("reqitr");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("itipreview");
                preview.src = reader.result;
            };
            itrForm();
        });

        function itrForm() {
            const input = document.getElementById("reqitr");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringItr = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringItr;
            };
            reader.readAsDataURL(file);
        }

        $(document).on("change", "#reqnfi", function (e) {
            const input = document.getElementById("reqnfi");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("nfipreview");
                preview.src = reader.result;
            };
            nfiForm();
        });

        function nfiForm() {
            const input = document.getElementById("reqnfi");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringNfi = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringNfi;
            };
            reader.readAsDataURL(file);
        }

        //#endregion

    });
</script>