<script>
    let studentId = "<%= studentid %>";
    let base64StringGradeCopy = "";
    let base64StringRegForm = "";
    let base64StringCertRes = "";
    let base64StringItr = "";
    let base64StringNfi = "";
    let base64profileImage = "";

    $(document).ready(function () {
        loadStudentData();
        LoadInstitutions();
        LoadCoursesOnly();


        $("#school_name").change(function () {
            var institutionId = $(this).val(); // Get the selected institution ID
            if (institutionId) {
                LoadCourses(institutionId);
            }
        });


        function LoadInstitutions() {
            $.ajax({
                type: "GET",
                url: "/institutions/loadinstitutions",
                success: function (result) {
                    var data = result.data;

                    $.each(data, function (key, item) {
                        var options = new Option(item.institutionsid, item.institutionsid);
                        $(options).html(item.name);
                        $("#school_name").append(options);
                    });
                },
                error: function (result) {
                    alert("error: " + result.data);
                },
            });
        }

        function LoadCourses(institutionId) {
            $.ajax({
                type: "POST",
                url: "/institutions/loadcourses",
                data: { institutionsid: institutionId },
                success: function (result) {
                    var data = result.data;
                    $("#course_strand").empty();

                    $.each(data, function (key, item) {
                        var options = new Option(item.course_id, item.course_id);
                        $(options).html(item.name_code);
                        $("#course_strand").append(options);
                    });
                },
                error: function (result) {
                    alert("error: " + result.data);
                },
            });
        }

        function LoadCoursesOnly() {
            $.ajax({
                type: "GET",
                url: "/courses/loadcourses",
                success: function (result) {
                    var data = result.data;
                    $.each(data, function (key, item) {
                        var options = new Option(item.course_id, item.course_id);
                        $(options).html(item.name_code);
                        $("#course_strand").append(options);
                    });
                },
                error: function (result) {
                    alert("error: " + result.data);
                },
            });
        }

        $(document).on("click", "#submit", function () {
            let first_name = $("#first_name").val();
            let middle_name = $("#middle_name").val();
            let last_name = $("#last_name").val();
            let dob = $("#dob").val();
            let birthplace = $("#birthplace").val();
            let phone = $("#phone").val();
            let gender = $("#gender").val();
            let age = $("#age").val();
            let scholar_status = $("#scholar_status").val();
            let student_id = $("#student_id").val();
            let school_name = $("#school_name").val();
            let course_strand = $("#course_strand").val();
            let year_level = $("#year_level").val();
            let academic_status = $("#academic_status").val();
            let register_date = $("#register_date").val();
            let city = $("#city").val();
            let barangay = $("#barangay").val();
            let village = $("#village").val();
            let street_address = $("#street_address").val();
            let houseno = $("#houseno").val();
            let fathersname = $("#fathersname").val();
            let fathersmonthly = $("#fathersmonthly").val();
            let fathersoccupation = $("#fathersoccupation").val();
            let mothersname = $("#mothersname").val();
            let mothersoccupation = $("#mothersoccupation").val();
            let mothersmonthly = $("#mothersmonthly").val();
            let imageFile = base64profileImage;
            let imageFileGradeCopy = base64StringGradeCopy;
            let imageFileRegForm = base64StringRegForm;
            let imageFileCertRes = base64StringCertRes;
            let imageFileItr = base64StringItr;
            let imageFileNfi = base64StringNfi;
            var message = "";

            console.log(imageFileGradeCopy, 'image');


            if (first_name == "") {
                message += "First Name ";
            }

            if (middle_name == "") {
                message += "Middle Name ";
            }

            if (last_name == "") {
                message += "Last Name ";
            }

            if (dob == "") {
                message += "Date of Birth ";
            }

            if (gender == "") {
                message += "Gender ";
            }

            if (phone == "") {
                message += "Phone ";
            }

            if (academic_status == "") {
                message += "Academic Status ";
            }

            if (year_level == "") {
                message += "Year Level ";
            }

            if (birthplace == "") {
                message += "Birth Place ";
            }

            if (age == "") {
                message += "Age ";
            }

            if (fathersname == "") {
                message += "Father's Name ";
            }

            if (fathersoccupation == "") {
                message += "Father's Occupation ";
            }

            if (fathersmonthly == "") {
                message += "Father's Salary Income ";
            }

            if (mothersname == "") {
                message += "Mother's Name ";
            }

            if (mothersoccupation == "") {
                message += "Mother's Occupation ";
            }

            if (mothersmonthly == "") {
                message += "Mother's Salary Income ";
            }

            if (message !== "") {
                swal("Validation Error", message, "error");
            } else {
                $.ajax({
                    type: "POST",
                    url: "/finishapplication/save",
                    data: {
                        studentid: studentId,
                        first_name: first_name,
                        middle_name: middle_name,
                        last_name: last_name,
                        dob: dob,
                        birthplace: birthplace,
                        phone: phone,
                        gender: gender,
                        age: age,
                        scholar_status: scholar_status,
                        school_name: school_name,
                        course_strand: course_strand,
                        year_level: year_level,
                        academic_status: academic_status,
                        register_date: register_date,
                        city: city,
                        barangay: barangay,
                        village: village,
                        street_address: street_address,
                        houseno: houseno,
                        fathersname: fathersname,
                        fathersmonthly: fathersmonthly,
                        fathersoccupation: fathersoccupation,
                        mothersname: mothersname,
                        mothersoccupation: mothersoccupation,
                        mothersmonthly: mothersmonthly,
                        imageFile: imageFile,
                        imageFileGradeCopy: imageFileGradeCopy,
                        imageFileRegForm: imageFileRegForm,
                        imageFileCertRes: imageFileCertRes,
                        imageFileItr: imageFileItr,
                        imageFileNfi: imageFileNfi,
                    },
                    success: function (result) {
                        if (result.msg == "success") {
                            swal({
                                title: "Saved Successfully",
                                text: "You clicked the button!",
                                icon: "success",
                                button: "OK!",
                            }).then((results) => {
                                window.location.reload();
                            });
                        } else {
                            swal({
                                title: "Exist",
                                text: "Data already exists!",
                                icon: "warning",
                                button: "OK!",
                            });
                        }
                    },
                    error: function (err) {
                        swal("Data already exists!", "You clicked the button!", "warning");
                    },
                });
            }
        });


        function loadStudentData() {
            $.ajax({
                type: "POST",
                url: "/finishapplication/loadexistingrecord",
                data: {
                    studentid: studentId,
                },
                success: function (result) {
                    if (result.msg === "success") {
                        const existingData = result.data;

                        $.each(existingData, (key, item) => {
                            $("#first_name").val(item.first_name);
                            $("#middle_name").val(item.middle_name);
                            $("#last_name").val(item.last_name);
                            $("#dob").val(item.date_of_birth);
                            $("#birthplace").val(item.birthplace);
                            $("#phone").val(item.phone);
                            $("#gender").val(item.gender);
                            $("#age").val(item.age);
                            // $("#scholar_status").val(item.status);
                            $("#student_id").val(item.studentid);
                            $("#school_name").val(item.institutionid);
                            $("#course_strand").val(item.courseid);
                            $("#year_level").val(item.year_level);
                            $("#academic_status").val(item.academic_status);
                            $("#register_date").val(item.registerdate);
                            $("#city").val(item.city);
                            $("#barangay").val(item.baranggay);
                            $("#village").val(item.village);
                            $("#street_address").val(item.street_address);
                            $("#houseno").val(item.house_no);
                            $("#fathersname").val(item.fathers_name);
                            $("#fathersmonthly").val(item.fathers_salary);
                            $("#fathersoccupation").val(item.fathers_occupation);
                            $("#mothersname").val(item.mothers_name);
                            $("#mothersoccupation").val(item.mothers_occupation);
                            $("#mothersmonthly").val(item.mothers_salary);
                            $("#image").attr("src", "data:image/jpg;base64," + item.image); // Ensure you have an element with id="image"
                        });
                    } else {
                        swal("Error fetching employee data", result.message, "error");
                    }
                },
                error: function (err) {
                    swal(
                        "An error occurred while fetching employee data",
                        err.message,
                        "error"
                    );
                },
            });
        }

        function previewImages(inputElement, dropArea) {
            const files = inputElement.files;
            dropArea.innerHTML = ''; // Clear previous previews

            for (const file of files) {
                const reader = new FileReader();

                if (file.type.startsWith('image/')) {
                    reader.onload = function (e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        dropArea.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Handle PDF and Word files
                    const fileName = file.name;
                    const fileIcon = file.type === 'application/pdf' ? 'fa-file-pdf-o' : 'fa-file-word-o';
                    const filePreview = document.createElement('div');
                    filePreview.classList.add('file-preview');
                    filePreview.innerHTML = `<i class="fa ${fileIcon}"></i> ${fileName}`;
                    dropArea.appendChild(filePreview);
                }
            }
        }

        var readURL = function (input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('.avatar').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]);
            }
        }


        $(".file-upload").on('change', function () {
            readURL(this);
        });

        document.querySelectorAll('.file-upload-input').forEach(inputElement => {
            const dropArea = inputElement.closest('.file-drop-area');

            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('dragover');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('dragover');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                inputElement.files = e.dataTransfer.files;
                previewImages(inputElement, dropArea);
            });

            inputElement.addEventListener('change', () => {
                previewImages(inputElement, dropArea);
            });
        });




        //#region File Upload

        $(document).on("change", "#profileImage", function (e) {
            const input = document.getElementById("profileImage");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("profileimagepreview");
                preview.src = reader.result;
            };
            profileImage();
        });

        function profileImage() {
            const input = document.getElementById("reqtruecopygrade");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringGradeCopy = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringGradeCopy;
            };
            reader.readAsDataURL(file);
        }

        $(document).on("change", "#reqtruecopygrade", function (e) {
            const input = document.getElementById("reqtruecopygrade");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("truecopypreview");
                preview.src = reader.result;
            };
            trueCopyGrade();
        });

        function trueCopyGrade() {
            const input = document.getElementById("reqtruecopygrade");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringGradeCopy = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringGradeCopy;
            };
            reader.readAsDataURL(file);
        }


        $(document).on("change", "#reqregform", function (e) {
            const input = document.getElementById("reqregform");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("regformpreview");
                preview.src = reader.result;
            };
            registrationForm();
        });

        function registrationForm() {
            const input = document.getElementById("reqregform");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringRegForm = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringRegForm;
            };
            reader.readAsDataURL(file);
        }


        $(document).on("change", "#reqcertres", function (e) {
            const input = document.getElementById("reqcertres");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("certrespreview");
                preview.src = reader.result;
            };
            certificateResidency();
        });

        function certificateResidency() {
            const input = document.getElementById("reqcertres");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringCertRes = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringCertRes;
            };
            reader.readAsDataURL(file);
        }


        $(document).on("change", "#reqitr", function (e) {
            const input = document.getElementById("reqitr");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("itipreview");
                preview.src = reader.result;
            };
            itrForm();
        });

        function itrForm() {
            const input = document.getElementById("reqitr");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringItr = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringItr;
            };
            reader.readAsDataURL(file);
        }

        $(document).on("change", "#reqnfi", function (e) {
            const input = document.getElementById("reqnfi");
            const file = input.files[0];

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const preview = document.getElementById("nfipreview");
                preview.src = reader.result;
            };
            nfiForm();
        });

        function nfiForm() {
            const input = document.getElementById("reqnfi");
            const file = input.files[0];

            var reader = new FileReader();

            reader.onload = function () {
                base64StringNfi = reader.result.replace("data:", "").replace(/^.+,/, "");

                imageBase64Stringsep = base64StringNfi;
            };
            reader.readAsDataURL(file);
        }

        //#endregion

    });
</script>