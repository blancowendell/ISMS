<script>
  let userid = "";

  $(document).ready(function () {
    console.log("Initializing");

    LoadInstitutions();
    loadAnnouncements();

    function loadAnnouncements() {
      $.ajax({
        type: "GET",
        url: "studentindex/getbulletin",
        success: function (result) {
          var data = result.data;

          // Clear previous content
          $('#announcement-container').empty();

          // Iterate over each announcement and dynamically create the content
          $.each(data, function (key, item) {
            // Create a row to hold both image and details
            var rowContainer = $('<div/>', {
              'class': 'row gy-5',
              'data-aos': 'fade-up',
              'data-aos-delay': 100 * (key + 1)
            }).appendTo('#announcement-container');

            // Create a div to hold the announcement image
            var imageContainer = $('<div/>', {
              'class': 'col-xl-5 d-flex align-items-center'
            }).appendTo(rowContainer);

            // Create an image element for the announcement
            $('<img/>', {
              'id': 'announcement-image-' + key,
              'src': 'data:image/jpg;base64,' + item.image,
              'class': 'img-fluid',
              'alt': item.title
            }).appendTo(imageContainer);

            // Create a container for the announcement details
            var detailContainer = $('<div/>', {
              'class': 'col-xl-7 d-flex align-items-center'
            }).appendTo(rowContainer);

            // Create a div to hold the announcement title and description
            var announcementDetail = $('<div/>', {
              'class': 'row align-self-center gy-5'
            }).appendTo(detailContainer);

            $('<h4/>', {
              'text': item.title
            }).appendTo(announcementDetail);

            $('<p/>', {
              'text': item.description
            }).appendTo(announcementDetail);
          });
        },
        error: function (result) {
          alert("Error fetching announcements: " + result.msg);
        }
      });
    }

    // Trigger LoadCourses when an institution is selected
    $("#school").change(function () {
      var institutionId = $(this).val(); // Get the selected institution ID
      if (institutionId) {
        LoadCourses(institutionId);
      }
    });

    function LoadInstitutions() {
      $.ajax({
        type: "GET",
        url: "/institutions/loadinstitutions",
        success: function (result) {
          var data = result.data;

          $.each(data, function (key, item) {
            var options = new Option(item.institutionsid, item.institutionsid);
            $(options).html(item.name);
            $("#school").append(options);
          });
        },
        error: function (result) {
          alert("error: " + result.data);
        },
      });
    }

    function LoadCourses(institutionId) {
      $.ajax({
        type: "POST",
        url: "/institutions/loadcourses",
        data: { institutionsid: institutionId },
        success: function (result) {
          var data = result.data;
          $("#course").empty();

          $.each(data, function (key, item) {
            var options = new Option(item.course_id, item.course_id);
            $(options).html(item.name_code);
            $("#course").append(options);
          });
        },
        error: function (result) {
          alert("error: " + result.data);
        },
      });
    }

    $(document).on("click", "#signupBtn", function () {
      let firstname = $("#firstname").val();
      let middlename = $("#middlename").val();
      let lastname = $("#lastname").val();
      let date_of_birth = $("#birthday").val();
      let email = $("#email").val();
      let gender = $("#gender").val();
      let phone = $("#phoneno").val();
      let institutionid = $("#school").val();
      let courseid = $("#course").val();
      let academic_status = $("#academic_status").val();
      let yearlevel = $("#yearlevel").val();
      let birthplace = $("#birthplace").val();
      let age = $("#age").val();
      let fathers_name = $("#fathersname").val();
      let fathers_occupation = $("#fatheroccupation").val();
      let fathers_salary = $("#fathersalaryincome").val();
      let mothers_name = $("#mothersname").val();
      let mothers_occupation = $("#mothersoccupation").val();
      let mothers_salary = $("#mothersalaryincome").val();
      let registerdate = $("#registerdate").val();
      // let certifyInfo = $("#usersname").val();
      // let agreeTerms = $("#usersname").val();

      console.log(firstname, "FIRSTNAME");

      var message = "";

      if (firstname == "") {
        message += "First Name ";
      }

      if (middlename == "") {
        message += "Middle Name ";
      }

      if (lastname == "") {
        message += "Last Name ";
      }

      if (date_of_birth == "") {
        message += "Date of Birth ";
      }

      if (email == "") {
        message += "Email ";
      }

      if (gender == "") {
        message += "Gender ";
      }

      if (phone == "") {
        message += "Phone ";
      }

      if (institutionid == "") {
        message += "Institution ";
      }

      if (courseid == "") {
        message += "Course ";
      }

      if (academic_status == "") {
        message += "Academic Status ";
      }

      if (yearlevel == "") {
        message += "Year Level ";
      }

      if (birthplace == "") {
        message += "Birth Place ";
      }

      if (age == "") {
        message += "Age ";
      }

      if (fathers_name == "") {
        message += "Father's Name ";
      }

      if (fathers_occupation == "") {
        message += "Father's Occupation ";
      }

      if (fathers_salary == "") {
        message += "Father's Salary Income ";
      }

      if (mothers_name == "") {
        message += "Mother's Name ";
      }

      if (mothers_occupation == "") {
        message += "Mother's Occupation ";
      }

      if (mothers_salary == "") {
        message += "Mother's Salary Income ";
      }
      // if (certifyInfo == "") {
      //     message += "Certification ";
      // }

      // if (agreeTerms == "") {
      //     message += "Agree Terms ";
      // }

      if (message !== "") {
        swal("Validation Error", message, "error");
      } else {
        $.ajax({
          type: "POST",
          url: "/landingpage/save",
          data: {
            firstname: firstname,
            middlename: middlename,
            lastname: lastname,
            date_of_birth: date_of_birth,
            email: email,
            gender: gender,
            phone: phone,
            institutionid: institutionid,
            courseid: courseid,
            academic_status: academic_status,
            yearlevel: yearlevel,
            birthplace: birthplace,
            age: age,
            fathers_name: fathers_name,
            fathers_occupation: fathers_occupation,
            fathers_salary: fathers_salary,
            mothers_name: mothers_name,
            mothers_occupation: mothers_occupation,
            mothers_salary: mothers_salary,
            registerdate: registerdate,
            // certifyInfo: certifyInfo,
            // agreeTerms: agreeTerms,
            // certifyInfo: certifyInfo,
            // agreeTerms: agreeTerms,
          },
          success: function (result) {
            if (result.msg === "success") {
              function promptOTP() {
                return swal({
                  text: "Enter the OTP sent to your email",
                  content: {
                    element: "input",
                    attributes: {
                      placeholder: "Enter OTP",
                      type: "text",
                    },
                  },
                  buttons: {
                    cancel: {
                      text: "Cancel",
                      value: "cancel",
                      visible: true,
                      closeModal: false,
                    },
                    confirm: {
                      text: "Verify",
                      closeModal: false,
                    },
                  },
                })
                  .then((otp) => {
                    if (otp === "cancel") {
                      return swal({
                        title: "Are you sure?",
                        text: "Do you really want to cancel the OTP verification?",
                        icon: "warning",
                        buttons: {
                          cancel: "No",
                          confirm: "Yes",
                        },
                        dangerMode: true,
                      }).then((willCancel) => {
                        if (willCancel) {
                          swal.close(); // Close the dialog
                          return Promise.reject("Cancelled");
                        } else {
                          return promptOTP(); // Reopen the OTP input dialog
                        }
                      });
                    }

                    if (!otp) {
                      return swal(
                        "No OTP entered",
                        "Please enter the OTP sent to your email.",
                        "error"
                      ).then(() => promptOTP()); // Reopen the OTP input dialog
                    }

                    return $.ajax({
                      type: "POST",
                      url: "/landingpage/verify-otp",
                      data: { email: $("#email").val(), otp: otp },
                    });
                  })
                  .then((response) => {
                    if (response && response.msg === "success") {
                      return swal({
                        title: "OTP Verified!",
                        text: "Check your email for creating your username and password.",
                        icon: "success",
                      }).then(() => {
                        // Send email with link to create username/password
                        return $.ajax({
                          type: "POST",
                          url: "/landingpage/send-create-account-link",
                          data: { email: $("#email").val() },
                        });
                      });
                    } else {
                      return swal(
                        "Invalid OTP",
                        "The OTP you entered is incorrect. Please try again.",
                        "warning"
                      ).then(() => promptOTP()); // Reopen the OTP input dialog
                    }
                  })
                  .catch((err) => {
                    if (err !== "Cancelled") {
                      // Handle error if not cancelled
                      swal(
                        "Error",
                        "Something went wrong. Please try again later.",
                        "error"
                      ).then(() => promptOTP()); // Reopen the OTP input dialog
                    }
                  });
              }

              promptOTP(); // Initial call to prompt for OTP
            } else {
              swal(
                "Looks like you already have an account",
                "Check your email for the OTP or Provide a new email",
                "warning"
              );
            }
          },
          error: function (err) {
            swal("Data already exists!", "You clicked the button!", "warning");
          },
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      const chatbotButton = document.getElementById('chatbot-button');
      const chatbotModal = document.getElementById('chatbot-modal');
      const closeButton = document.getElementById('close-button');

      chatbotButton.addEventListener('click', function () {
        chatbotModal.style.display = 'block';
      });

      closeButton.addEventListener('click', function () {
        chatbotModal.style.display = 'none';
      });

      // Optional: Close the modal when clicking outside of it
      window.addEventListener('click', function (event) {
        if (event.target === chatbotModal) {
          chatbotModal.style.display = 'none';
        }
      });
    });

    // $('#chatbotModal').on('shown.bs.modal', function () {
    //   setTimeout(function () {
    //     displayMessage("Chatbot", '<span class="wave">👋</span> Hi there! How can I assist you today?');
    //   }, 500); // Delay for animation effect
    // });

    // $("#sendButton").click(function () {
    //   const message = $("#chatInput").val();
    //   if (message.trim() === "") return;

    //   // Display user's message
    //   displayMessage("You", message);

    //   $.ajax({
    //     url: "landingpage/send",
    //     type: "POST",
    //     data: {
    //       message: message,
    //     },
    //     success: function (result) {
    //       if (result.msg == "success" && result.data.length > 0) {
    //         displayMessage("Chatbot", result.data[0].description);
    //       } else {
    //         displayMessage("Chatbot", "Sorry, I couldn't find an answer to your question.");
    //       }
    //     },
    //     error: function (err) {
    //       displayMessage("Chatbot", "There was an error processing your request.");
    //     },
    //   });

    //   $("#chatInput").val("");
    // });

    // function displayMessage(sender, message) {
    //   const chatBody = $("#chatBody");

    //   let messageHtml = "";
    //   if (sender === "You") {
    //     messageHtml = `
    //   <div class="d-flex justify-content-end mb-2">
    //     <div class="d-flex flex-row justify-content-end">
    //       <div>
    //         <p class="small p-2 me-3 mb-3 text-white rounded-3 bg-primary">${message}</p>
    //       </div>
    //     </div>
    //   </div>`;
    //   } else {
    //     messageHtml = `
    //   <div class="d-flex justify-content-start mb-2">
    //     <div class="d-flex flex-row justify-content-start">
    //       <div>
    //         <p class="small p-2 ms-3 mb-3 rounded-3 bg-body-tertiary">${message}</p>
    //       </div>
    //     </div>
    //   </div>`;
    //   }

    //   chatBody.append(messageHtml);
    //   chatBody.scrollTop(chatBody[0].scrollHeight); // Auto-scroll to the bottom
    // }
    // Fetch and display frequent questions when the modal is shown
    $('#chatbotModal').on('shown.bs.modal', function () {
      setTimeout(function () {
        // Display initial greeting
        displayMessage("Chatbot", '<span class="wave">👋</span> Hi there! How can I assist you today?');

        // Fetch frequent questions
        $.ajax({
          url: 'landingpage/loadfrequentquestions',
          type: 'GET',
          success: function (result) {
            if (result.msg == "success" && result.data.length > 0) {
              let frequentQuestionsHtml = result.data.map(item => `<p><a href="#" class="frequent-question">${item.description}</a></p>`).join('');
              $('#frequentQuestions').html('<strong>Frequently Asked Questions:</strong><br>' + frequentQuestionsHtml);
            } else {
              $('#frequentQuestions').html('<strong>No frequent questions available.</strong>');
            }
          },
          error: function (err) {
            $('#frequentQuestions').html('<strong>Error loading frequent questions.</strong>');
          }
        });
      }, 500); // Delay for animation effect
    });

    // Handle frequent question clicks
    $(document).on('click', '.frequent-question', function (e) {
      e.preventDefault();
      let question = $(this).text();

      // Display the clicked question in the chat
      displayMessage("You", question);

      $.ajax({
        url: "landingpage/send",
        type: "POST",
        data: {
          message: question,
        },
        success: function (result) {
          if (result.msg == "success" && result.data.length > 0) {
            displayMessage("Chatbot", result.data[0].description);
          } else {
            displayMessage("Chatbot", "Sorry, I couldn't find an answer to your question.");
          }
        },
        error: function (err) {
          displayMessage("Chatbot", "There was an error processing your request.");
        }
      });
    });

    $("#sendButton").click(function () {
      const message = $("#chatInput").val();
      if (message.trim() === "") return;

      // Display user's message
      displayMessage("You", message);

      $.ajax({
        url: "landingpage/send",
        type: "POST",
        data: {
          message: message,
        },
        success: function (result) {
          if (result.msg == "success" && result.data.length > 0) {
            displayMessage("Chatbot", result.data[0].description);
          } else {
            displayMessage("Chatbot", "Sorry, I couldn't find an answer to your question.");
          }
        },
        error: function (err) {
          displayMessage("Chatbot", "There was an error processing your request.");
        }
      });

      $("#chatInput").val("");
    });

    function displayMessage(sender, message) {
      const chatBody = $("#chatBody");

      let messageHtml = "";
      if (sender === "You") {
        messageHtml = `
      <div class="d-flex justify-content-end mb-2">
        <div class="d-flex flex-row justify-content-end">
          <div>
            <p class="small p-2 me-3 mb-3 text-white rounded-3 bg-primary">${message}</p>
          </div>
        </div>
      </div>`;
      } else {
        messageHtml = `
      <div class="d-flex justify-content-start mb-2">
        <div class="d-flex flex-row justify-content-start">
          <div>
            <p class="small p-2 ms-3 mb-3 rounded-3 bg-body-tertiary">${message}</p>
          </div>
        </div>
      </div>`;
      }

      chatBody.append(messageHtml);
      chatBody.scrollTop(chatBody[0].scrollHeight); // Auto-scroll to the bottom
    }

    $.ajax({
      url: 'landingpage/frequentquestions',
      type: 'GET',
      success: function (result) {
        if (result.msg === "success" && result.data.length > 0) {
          let faqItemsHtml = result.data.map(item => `
          <div class="faq-item" data-aos="fade-up">
            <div class="faq-question">
              <i class="faq-icon bi bi-question-circle"></i>
              <h3>${item.description}</h3>
              <i class="faq-toggle bi bi-chevron-right"></i>
            </div>
            <div class="faq-answer" style="display: none;">
              <p>${item.answer}</p>
            </div>
          </div>
        `).join('');

          $('#faqContainer').html(faqItemsHtml);

          // Initialize AOS (Animate On Scroll) if needed
          AOS.init();
        } else {
          $('#faqContainer').html('<p>No frequent questions available.</p>');
        }
      },
      error: function (err) {
        $('#faqContainer').html('<p>Error loading frequent questions.</p>');
        console.error('Error fetching FAQ data:', err);
      }
    });

    // Add click event to toggle FAQ content
    $(document).on('click', '.faq-question', function () {
      $(this).next('.faq-answer').slideToggle();
      $(this).find('.faq-toggle').toggleClass('bi-chevron-right bi-chevron-down');
    });
  });
</script>